<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Application de Course</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
    }
    #map {
      flex: 1;
      position: relative;
    }
    #controls {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      background: #fff;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    }
    button {
      cursor: pointer;
      border: none;
      background: #007BFF;
      color: white;
      font-size: 16px;
      padding: 10px 20px;
      margin: 0 10px;
      border-radius: 8px;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #0056b3;
    }
    #startStop {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      background: #007BFF;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      box-shadow: 0 4px 10px rgba(0,123,255,0.5);
      user-select: none;
    }
    #stats {
      background: white;
      padding: 10px 20px;
      font-size: 16px;
      color: #333;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
      font-weight: 600;
    }
    #geolocBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      border: 2px solid #007BFF;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 15;
      box-shadow: 0 2px 6px rgba(0,123,255,0.3);
    }
    #geolocBtn:hover {
      background: #e6f0ff;
    }
    /* Cercle bleu autour de la position */
    .geoloc-circle {
      width: 100px;
      height: 100px;
      border: 3px solid #007BFF;
      border-radius: 50%;
      position: absolute;
      pointer-events: none;
      animation: pulse 2s infinite;
      opacity: 0.4;
      z-index: 14;
    }
    @keyframes pulse {
      0% {transform: scale(1); opacity: 0.4;}
      50% {transform: scale(1.4); opacity: 0;}
      100% {transform: scale(1); opacity: 0.4;}
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="startStop">START</div>
<div id="geolocBtn" title="Me géolocaliser">&#128269;</div>

<div id="stats" style="display:none;">
  <div>Temps: <span id="chrono">00:00:00</span></div>
  <div>Distance: <span id="distance">0.00</span> km</div>
  <div>Dénivelé: <span id="denivele">0</span> m</div>
  <div>Km-effort: <span id="kmeffort">0.00</span></div>
</div>

<div id="historiqueBtnContainer" style="text-align:center; margin:10px;">
  <button id="btnHistorique">Historique</button>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
  mapboxgl.accessToken = 'TA_CLE_MAPBOX_ICI'; // Remplace par ta clé

  let map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/outdoors-v12',
    center: [2.3522, 48.8566], // Paris par défaut
    zoom: 12
  });

  // Différents styles de fond
  const styles = {
    outdoors: 'mapbox://styles/mapbox/outdoors-v12',
    satellite: 'mapbox://styles/mapbox/satellite-v9',
    streets: 'mapbox://styles/mapbox/streets-v12',
    light: 'mapbox://styles/mapbox/light-v11'
  };

  // Ajouter un control style switcher simple
  const styleSelector = document.createElement('select');
  styleSelector.style.position = 'absolute';
  styleSelector.style.top = '10px';
  styleSelector.style.left = '10px';
  styleSelector.style.zIndex = '15';
  styleSelector.style.padding = '5px';
  for(let key in styles){
    let option = document.createElement('option');
    option.value = styles[key];
    option.textContent = key.charAt(0).toUpperCase() + key.slice(1);
    styleSelector.appendChild(option);
  }
  styleSelector.addEventListener('change', (e) => {
    map.setStyle(e.target.value);
  });
  document.body.appendChild(styleSelector);

  // Variables course
  let running = false;
  let path = [];
  let watchId = null;
  let startTime = 0;
  let timerInterval = null;
  let distance = 0;
  let denivele = 0;
  let lastAltitude = null;
  let kmeffort = 0;

  const startStopBtn = document.getElementById('startStop');
  const chronoEl = document.getElementById('chrono');
  const distanceEl = document.getElementById('distance');
  const deniveleEl = document.getElementById('denivele');
  const kmeffortEl = document.getElementById('kmeffort');
  const statsEl = document.getElementById('stats');
  const geolocBtn = document.getElementById('geolocBtn');

  // Cercle bleu de géoloc
  let geolocCircle = null;

  // Fonction pour formater la durée en hh:mm:ss
  function formatTime(ms) {
    let totalSeconds = Math.floor(ms / 1000);
    let h = Math.floor(totalSeconds / 3600);
    let m = Math.floor((totalSeconds % 3600) / 60);
    let s = totalSeconds % 60;
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  // Calcul distance en km entre 2 points [lng, lat]
  function calcDistance(coord1, coord2){
    const R = 6371e3; // m
    const toRad = (deg) => deg * Math.PI / 180;
    let lat1 = toRad(coord1[1]);
    let lat2 = toRad(coord2[1]);
    let dLat = lat2 - lat1;
    let dLon = toRad(coord2[0] - coord1[0]);

    let a = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return (R * c)/1000; // km
  }

  // Met à jour les stats km-effort simple = distance * (1 + dénivelé / 1000)
  function majKmEffort(dist, deniv){
    return dist * (1 + deniv / 1000);
  }

  // Fonction pour créer cercle bleu géoloc
  function ajouterCercleGeoloc(lngLat){
    if(geolocCircle) geolocCircle.remove();
    geolocCircle = document.createElement('div');
    geolocCircle.className = 'geoloc-circle';
    // Convertir coordonnées lngLat en pixels sur la carte
    let pixel = map.project(lngLat);
    geolocCircle.style.left = (pixel.x - 50) + 'px';
    geolocCircle.style.top = (pixel.y - 50) + 'px';
    geolocCircle.style.position = 'absolute';
    geolocCircle.style.zIndex = '10';
    document.getElementById('map').appendChild(geolocCircle);
  }

  // Met à jour position cercle lors du mouvement de la carte
  map.on('move', () => {
    if(geolocCircle && path.length){
      let lastCoord = path[path.length - 1];
      let pixel = map.project(lastCoord);
      geolocCircle.style.left = (pixel.x - 50) + 'px';
      geolocCircle.style.top = (pixel.y - 50) + 'px';
    }
  });

  // Fonction démarrage course
  function startCourse(){
    running = true;
    startTime = Date.now();
    path = [];
    distance = 0;
    denivele = 0;
    lastAltitude = null;
    kmeffort = 0;
    statsEl.style.display = 'flex';
    startStopBtn.textContent = 'STOP';

    // Supprimer ancien tracé si existant
    if(map.getSource('path')){
      map.removeLayer('pathLine');
      map.removeSource('path');
    }

    watchId = navigator.geolocation.watchPosition(position => {
      const {latitude, longitude, altitude} = position.coords;
      const coord = [longitude, latitude];
      path.push(coord);

      // Ajout ou mise à jour cercle bleu géoloc
      ajouterCercleGeoloc(coord);

      // Centre carte sur position
      map.easeTo({center: coord});

      // Calcul distance
      if(path.length > 1){
        distance += calcDistance(path[path.length-2], path[path.length-1]);
      }

      // Calcul dénivelé
      if(lastAltitude !== null && altitude !== null){
        let diffAlt = altitude - lastAltitude;
        if(diffAlt > 0) denivele += diffAlt; // on ne compte que les montées
      }
      lastAltitude = altitude;

      // Calcul km-effort
      kmeffort = majKmEffort(distance, denivele);

      // Affichage
      distanceEl.textContent = distance.toFixed(2);
      deniveleEl.textContent = Math.round(denivele);
      kmeffortEl.textContent = kmeffort.toFixed(2);

      // Tracé ligne sur la carte
      if(map.getSource('path')){
        map.getSource('path').setData({
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: path
          }
        });
      } else {
        map.addSource('path', {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: {
              type: 'LineString',
              coordinates: path
            }
          }
        });
        map.addLayer({
          id: 'pathLine',
          type: 'line',
          source: 'path',
          layout: {
            'line-join': 'round',
            'line-cap': 'round'
          },
          paint: {
            'line-color': '#007BFF',
            'line-width': 5
          }
        });
      }
    }, err => {
      alert('Erreur de géolocalisation : ' + err.message);
      stopCourse();
    }, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    });

    // Lancer chrono
    timerInterval = setInterval(() => {
      let elapsed = Date.now() - startTime;
      chronoEl.textContent = formatTime(elapsed);
    }, 1000);
  }

  // Fonction arrêt course
  function stopCourse(){
    running = false;
    startStopBtn.textContent = 'START';
    statsEl.style.display = 'none';

    if(watchId !== null){
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }

    clearInterval(timerInterval);
    timerInterval = null;

    // Enregistrer parcours dans le localStorage
    enregistrerParcours({
      date: new Date().toISOString(),
      duration: Date.now() - startTime,
      distance: distance,
      denivele: denivele,
      kmeffort: kmeffort,
      path: path
    });
  }

  // Fonction toggle start/stop
  startStopBtn.addEventListener('click', () => {
    if(!running){
      startCourse();
    } else {
      stopCourse();
    }
  });

  // Fonction géolocalisation simple au clic sur bouton bleu
  geolocBtn.addEventListener('click', () => {
    navigator.geolocation.getCurrentPosition(position => {
      const {longitude, latitude} = position.coords;
      map.easeTo({center: [longitude, latitude], zoom: 15});
    }, err => {
      alert('Erreur géolocalisation : ' + err.message);
    }, {enableHighAccuracy: true});
  });

  // Fonction enregistrer parcours dans localStorage
  function enregistrerParcours(parcours){
    let historiques = JSON.parse(localStorage.getItem('historiques')) || [];
    historiques.push(parcours);
    localStorage.setItem('historiques', JSON.stringify(historiques));
    alert('Parcours enregistré !');
  }

  // Fonction afficher dernier parcours dans console (exemple simple)
  function afficherDernierParcours(){
    let historiques = JSON.parse(localStorage.getItem('historiques')) || [];
    if(historiques.length === 0){
      alert('Aucun parcours enregistré.');
      return;
    }
    const dernier = historiques[historiques.length - 1];
    let msg = `Dernier parcours :\nDate : ${new Date(dernier.date).toLocaleString()}\nDurée : ${formatTime(dernier.duration)}\nDistance : ${dernier.distance.toFixed(2)} km\nDénivelé : ${Math.round(dernier.denivele)} m\nKm-effort : ${dernier.kmeffort.toFixed(2)}\nPoints GPS : ${dernier.path.length}`;
    alert(msg);
    // Ici tu peux ajouter un affichage plus graphique (tracé etc.) dans une autre page
  }

  // Bouton historique
  document.getElementById('btnHistorique').addEventListener('click', afficherDernierParcours);

</script>
</body>
</html>

