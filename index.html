<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Course - Tracker</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body, html { margin:0; padding:0; height:100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
  #map { position: absolute; top:0; bottom:150px; width: 100%; }
  .controls {
    position: absolute;
    bottom: 0; left:0; width: 100%;
    background: #fff;
    padding: 15px;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.15);
    display: flex; justify-content: space-around; align-items: center;
    font-size: 1.1rem;
    gap: 15px;
    flex-wrap: wrap;
  }
  button#startStop {
    background: #007BFF; color:#fff; border:none; padding: 10px 25px; font-size: 1.2rem;
    border-radius: 30px;
    cursor: pointer;
    transition: background 0.3s ease;
    min-width: 120px;
  }
  button#startStop:hover {
    background: #0056b3;
  }
  select {
    padding: 6px 10px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  .data-item {
    flex: 1 1 120px;
    text-align: center;
    background: #e3eefd;
    padding: 8px 12px;
    border-radius: 10px;
    color: #003366;
    font-weight: 600;
  }
  .geoloc-btn {
    position: absolute;
    top: 15px; right: 15px;
    background: #fff;
    border-radius: 50%;
    width: 44px; height: 44px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    display: flex; justify-content: center; align-items: center;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .geoloc-btn:hover {
    background: #e0ebff;
  }
  .geoloc-btn svg {
    fill: #007BFF;
    width: 24px; height: 24px;
  }
</style>
</head>
<body>

<div id="map"></div>

<button class="geoloc-btn" id="btnGeoloc" title="Me géolocaliser" aria-label="Bouton géolocalisation">
  <svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm0-7a1 1 0 0 1 1 1v2.08a7.992 7.992 0 0 1 6.92 6.92H21a1 1 0 1 1 0 2h-2.08a7.992 7.992 0 0 1-6.92 6.92V21a1 1 0 1 1-2 0v-2.08a7.992 7.992 0 0 1-6.92-6.92H3a1 1 0 1 1 0-2h2.08a7.992 7.992 0 0 1 6.92-6.92V3a1 1 0 0 1 1-1z"/></svg>
</button>

<div class="controls">
  <select id="styleSelector" title="Changer le fond de carte">
    <option value="mapbox/streets-v12">Streets</option>
    <option value="mapbox/outdoors-v12">Outdoors</option>
    <option value="mapbox/light-v11">Light</option>
    <option value="mapbox/dark-v11">Dark</option>
    <option value="mapbox/satellite-v9">Satellite</option>
    <option value="mapbox/satellite-streets-v12">Satellite Streets</option>
  </select>

  <button id="startStop">Démarrer</button>

  <div class="data-item">Chrono : <span id="chrono">00:00:00</span></div>
  <div class="data-item">Distance : <span id="distance">0.00</span> km</div>
  <div class="data-item">Dénivelé : <span id="denivele">0</span> m</div>
  <div class="data-item">Km-Effort : <span id="kmeffort">0.00</span></div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiZ3ViaW5xIiwiYSI6ImNrbnlubnVwYjBsMjgyb3J4b3hqM2YwOGsifQ.KV-VZe4nIEMc7rhtHmM5BQ';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [2.3522, 48.8566], // Paris par défaut
    zoom: 13
  });

  // Ajout cercle bleu géoloc
  let userMarker = null;
  let userCircle = null;
  let userPosition = null;

  // Calques possibles
  const styleBase = {
    'mapbox/streets-v12': 'mapbox://styles/mapbox/streets-v12',
    'mapbox/outdoors-v12': 'mapbox://styles/mapbox/outdoors-v12',
    'mapbox/light-v11': 'mapbox://styles/mapbox/light-v11',
    'mapbox/dark-v11': 'mapbox://styles/mapbox/dark-v11',
    'mapbox/satellite-v9': 'mapbox://styles/mapbox/satellite-v9',
    'mapbox/satellite-streets-v12': 'mapbox://styles/mapbox/satellite-streets-v12'
  };

  document.getElementById('styleSelector').addEventListener('change', (e) => {
    const styleId = e.target.value;
    map.setStyle(styleBase[styleId]);
    // Remettre le marker et cercle après changement style
    map.once('styledata', () => {
      if(userPosition){
        addUserMarker(userPosition);
      }
      if(pathLine) {
        map.addSource('path', {
          type: 'geojson',
          data: pathLine
        });
        map.addLayer({
          id: 'pathLine',
          type: 'line',
          source: 'path',
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': '#007BFF', 'line-width': 4 }
        });
      }
    });
  });

  // Fonction pour ajouter cercle bleu + marker
  function addUserMarker(position){
    if(userMarker) userMarker.remove();
    if(userCircle) map.removeLayer('userCircle');

    userMarker = new mapboxgl.Marker({color: '#007BFF'})
      .setLngLat(position)
      .addTo(map);

    // Cercle bleu autour
    const circleRadius = 50; // en mètres

    const circleFeature = turf.circle(position, circleRadius/1000, {steps:64, units:'kilometers'});

    if(map.getSource('userCircle')){
      map.getSource('userCircle').setData(circleFeature);
    } else {
      map.addSource('userCircle', {
        type: 'geojson',
        data: circleFeature
      });
      map.addLayer({
        id: 'userCircle',
        type: 'fill',
        source: 'userCircle',
        layout: {},
        paint: {
          'fill-color': '#007BFF',
          'fill-opacity': 0.2
        }
      });
    }
  }

  // GEOLOCALISATION
  const geolocBtn = document.getElementById('btnGeoloc');
  geolocBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Géolocalisation non supportée par ce navigateur');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const coords = [pos.coords.longitude, pos.coords.latitude];
      userPosition = coords;
      map.flyTo({center: coords, zoom: 16});
      addUserMarker(coords);
    }, err => {
      alert('Erreur géolocalisation : ' + err.message);
    }, {enableHighAccuracy:true});
  });

  // Gestion course
  let isRunning = false;
  let watchId = null;
  let startTime = null;
  let timerInterval = null;
  let pathCoords = [];
  let totalDistance = 0;
  let lastElevation = null;
  let totalDenivele = 0;
  let kmeffort = 0;

  const chronoEl = document.getElementById('chrono');
  const distanceEl = document.getElementById('distance');
  const deniveleEl = document.getElementById('denivele');
  const kmeffortEl = document.getElementById('kmeffort');
  const startStopBtn = document.getElementById('startStop');

  // Ligne du parcours (geojson)
  let pathLine = {
    type: 'FeatureCollection',
    features: [{
      type: 'Feature',
      geometry: {
        type: 'LineString',
        coordinates: []
      }
    }]
  };

  // Fonction calcul distance entre 2 coords (en km)
  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // rayon terre km
    const dLat = (lat2-lat1) * Math.PI / 180;
    const dLon = (lon2-lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI /180) * Math.cos(lat2 * Math.PI /180) *
              Math.sin(dLon/2)*Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }

  // Timer affichage
  function updateChrono(){
    const now = new Date().getTime();
    const diff = now - startTime;
    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    chronoEl.textContent = 
      `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  // Start course
  function startCourse(){
    if (!navigator.geolocation) {
      alert('Géolocalisation non supportée');
      return;
    }

    startTime = new Date().getTime();
    pathCoords = [];
    totalDistance = 0;
    totalDenivele = 0;
    lastElevation = null;
    kmeffort = 0;

    startStopBtn.textContent = 'Arrêter';
    isRunning = true;

    watchId = navigator.geolocation.watchPosition(position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const ele = position.coords.altitude ?? 0;

      const currentPos = [lon, lat];

      if(pathCoords.length > 0){
        const lastPos = pathCoords[pathCoords.length-1];
        const dist = distanceKm(lastPos[1], lastPos[0], lat, lon);
        totalDistance += dist;

        // Calcul dénivelé positif uniquement
        if(lastElevation !== null){
          const dElev = ele - lastElevation;
          if(dElev > 0) totalDenivele += dElev;
        }
        lastElevation = ele;

        // Calcul km-effort (distance * (1 + dénivelé/100))
        kmeffort = totalDistance * (1 + totalDenivele/100);
      }

      pathCoords.push(currentPos);

      // Mise à jour carte
      pathLine.features[0].geometry.coordinates = pathCoords;
      if(map.getSource('path')){
        map.getSource('path').setData(pathLine);
      } else {
        map.addSource('path', {
          type: 'geojson',
          data: pathLine
        });
        map.addLayer({
          id: 'pathLine',
          type: 'line',
          source: 'path',
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': '#007BFF', 'line-width': 4 }
        });
      }

      // Ajout marker utilisateur
      userPosition = currentPos;
      addUserMarker(currentPos);

      // Mise à jour affichage
      distanceEl.textContent = totalDistance.toFixed(2);
      deniveleEl.textContent = Math.round(totalDenivele);
      kmeffortEl.textContent = kmeffort.toFixed(2);
    }, err => {
      alert('Erreur géolocalisation :' + err.message);
    }, {enableHighAccuracy:true, maximumAge: 1000, timeout: 10000});

    timerInterval = setInterval(updateChrono, 1000);
  }

  // Stop course
  function stopCourse(){
    isRunning = false;
    startStopBtn.textContent = 'Démarrer';

    if(watchId !== null){
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    clearInterval(timerInterval);

    // Enregistrement parcours
    const endTime = new Date().getTime();
    const durationMs = endTime - startTime;

    if(pathCoords.length < 2){
      alert('Parcours trop court pour être sauvegardé');
      return;
    }

    const parcours = {
      id: 'course_' + Date.now(),
      date: new Date(startTime).toISOString(),
      duration: durationMs,
      distance: totalDistance,
      denivele: totalDenivele,
      kmeffort: kmeffort,
      path: pathCoords
    };

    // Sauvegarde dans localStorage
    let histos = JSON.parse(localStorage.getItem('historiquesCourses') || '[]');
    histos.push(parcours);
    localStorage.setItem('historiquesCourses', JSON.stringify(histos));

    // Redirection vers page récapitulatif
    sessionStorage.setItem('dernierParcours', JSON.stringify(parcours));
    window.location.href = 'fin.html';
  }

  startStopBtn.addEventListener('click', () => {
    if(isRunning){
      stopCourse();
    } else {
      startCourse();
    }
  });
</script>

<!-- Turf.js pour cercle -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

</body>
</html>

a
